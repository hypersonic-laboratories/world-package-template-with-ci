name: "Create Package Version"
description: "Creates a new package version via API using metadata.json"

inputs:
  api-url:
    description: "API base URL"
    required: true
  api-token:
    description: "API authentication token"
    required: true
  archive-path:
    description: "Path to the package archive"
    required: true
  archive-size:
    description: "Size of the archive in bytes"
    required: true

outputs:
  version-id:
    description: "Created version ID"
    value: ${{ steps.create-version.outputs.version-id }}
  package-id:
    description: "Package ID"
    value: ${{ steps.create-version.outputs.package-id }}
  client-upload-url:
    description: "Pre-signed URL for client upload"
    value: ${{ steps.create-version.outputs.client-upload-url }}
  server-upload-url:
    description: "Pre-signed URL for server upload"
    value: ${{ steps.create-version.outputs.server-upload-url }}

runs:
  using: "composite"
  steps:
    - name: Read metadata
      id: read-metadata
      shell: bash
      run: |
        if [ ! -f "metadata.json" ]; then
          echo "❌ Error: metadata.json not found"
          exit 1
        fi

        # Extract package ID and dependency IDs from metadata.json
        PACKAGE_ID=$(jq -r '.package.id' metadata.json)
        DEPENDENCY_IDS=$(jq -c '.dependencyIds // []' metadata.json)

        if [ "$PACKAGE_ID" = "null" ] || [ -z "$PACKAGE_ID" ]; then
          echo "❌ Error: package.id not found in metadata.json"
          exit 1
        fi

        echo "package-id=$PACKAGE_ID" >> $GITHUB_OUTPUT
        echo "dependency-ids=$DEPENDENCY_IDS" >> $GITHUB_OUTPUT
        echo "✅ Package ID: $PACKAGE_ID"
        echo "✅ Dependencies: $DEPENDENCY_IDS"

    - name: Create package version
      id: create-version
      shell: bash
      env:
        API_URL: ${{ inputs.api-url }}
        API_TOKEN: ${{ inputs.api-token }}
        PACKAGE_ID: ${{ steps.read-metadata.outputs.package-id }}
        DEPENDENCY_IDS: ${{ steps.read-metadata.outputs.dependency-ids }}
        ARCHIVE_SIZE: ${{ inputs.archive-size }}
      run: |
        # Construct the payload
        PAYLOAD=$(jq -n \
          --arg packageId "$PACKAGE_ID" \
          --argjson clientSize "$ARCHIVE_SIZE" \
          --argjson serverSize "$ARCHIVE_SIZE" \
          --argjson dependencyIds "$DEPENDENCY_IDS" \
          '{
            packageId: $packageId,
            clientSize: $clientSize,
            serverSize: $serverSize,
            dependencyIds: $dependencyIds
          }')

        echo "📤 Creating package version..."
        echo "Payload: $PAYLOAD"

        # Make the API request
        RESPONSE=$(curl -s -w "\n%{http_code}" \
          -X POST \
          -H "Content-Type: application/json" \
          -H "Authorization: Bearer $API_TOKEN" \
          -d "$PAYLOAD" \
          "$API_URL/api/v1/package-versions")

        # Extract HTTP status code and body
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        BODY=$(echo "$RESPONSE" | sed '$d')

        echo "HTTP Status: $HTTP_CODE"

        if [ "$HTTP_CODE" -ne 200 ] && [ "$HTTP_CODE" -ne 201 ]; then
          echo "❌ Error: Failed to create package version (HTTP $HTTP_CODE)"
          echo "Response: $BODY"
          exit 1
        fi

        # Parse response
        VERSION_ID=$(echo "$BODY" | jq -r '.item.id')
        CLIENT_UPLOAD_URL=$(echo "$BODY" | jq -r '.item.clientUploadUrl')
        SERVER_UPLOAD_URL=$(echo "$BODY" | jq -r '.item.serverUploadUrl')

        if [ "$VERSION_ID" = "null" ] || [ -z "$VERSION_ID" ]; then
          echo "❌ Error: Failed to parse version ID from response"
          echo "Response: $BODY"
          exit 1
        fi

        echo "version-id=$VERSION_ID" >> $GITHUB_OUTPUT
        echo "package-id=$PACKAGE_ID" >> $GITHUB_OUTPUT
        echo "client-upload-url=$CLIENT_UPLOAD_URL" >> $GITHUB_OUTPUT
        echo "server-upload-url=$SERVER_UPLOAD_URL" >> $GITHUB_OUTPUT

        echo "✅ Package version created: $VERSION_ID"
